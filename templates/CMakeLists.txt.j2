cmake_minimum_required(VERSION 3.10)
project({{ project_name }} LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ============================================================
# DEPENDENCIES
# ============================================================
{% if use_streampu %}
set(STREAMPU_ROOT "{{ streampu_root }}" CACHE PATH "Path to StreamPU")
{% endif %}

{% if use_aff3ct %}
set(AFF3CT_ROOT "{{ aff3ct_root }}" CACHE PATH "Path to AFF3CT")
{% endif %}

{% if use_hw %}
# Verilator support (CMake config provided by Verilator 5+)
find_package(verilator REQUIRED)
find_package(Threads REQUIRED)
{% endif %}

# ============================================================
# LOAD HULOTTE ENVIRONMENT
# ============================================================

{% if use_aff3ct %}
# Configure AFF3CT paths
set(AFF3CT_INCLUDE_DIRS
    ${AFF3CT_ROOT}/include
    ${AFF3CT_ROOT}/src
    ${AFF3CT_ROOT}/lib/MIPP/src
    ${AFF3CT_ROOT}/lib/cli/src
    ${AFF3CT_ROOT}/lib/date/include/date
)
include_directories(${AFF3CT_INCLUDE_DIRS})

# Find AFF3CT library
file(GLOB AFF3CT_LIBRARY "${AFF3CT_ROOT}/build/lib/libaff3ct*.a")

if(AFF3CT_LIBRARY)
    message(STATUS "Found AFF3CT: ${AFF3CT_LIBRARY}")
    
    # When using AFF3CT, use the StreamPU headers/symbols bundled in AFF3CT
    # to avoid Diamond Dependency / ABI mismatches.
    set(STREAMPU_INCLUDE_DIRS
        ${AFF3CT_ROOT}/lib/streampu/include
        ${AFF3CT_ROOT}/lib/streampu/lib/rang/include
        ${AFF3CT_ROOT}/lib/streampu/lib/json/include
    )
    include_directories(${STREAMPU_INCLUDE_DIRS})
    
    # Link ONLY AFF3CT (it contains StreamPU symbols)
    set(HULOTTE_LIBS ${AFF3CT_LIBRARY})
    
    add_definitions(-DHULOTTE_USE_AFF3CT)
    add_definitions(-DAFF3CT_POLAR_BIT_PACKING)
    add_definitions(-DAFF3CT_MULTI_PREC)
    add_definitions(-DSPU_STACKTRACE)
else()
    message(WARNING "AFF3CT library not found! Falling back to standalone StreamPU.")
    
    # Standalone StreamPU
    set(STREAMPU_INCLUDE_DIRS
        ${STREAMPU_ROOT}/include
        ${STREAMPU_ROOT}/src
        ${STREAMPU_ROOT}/lib/rang/include
        ${STREAMPU_ROOT}/lib/json/include
    )
    include_directories(${STREAMPU_INCLUDE_DIRS})
    
    if(EXISTS "${STREAMPU_ROOT}/build/lib/libstreampu.a")
        set(HULOTTE_LIBS "${STREAMPU_ROOT}/build/lib/libstreampu.a")
    else()
        message(FATAL_ERROR "libstreampu.a not found at ${STREAMPU_ROOT}/build/lib/libstreampu.a")
    endif()
endif()
{% else %}
# Standard StreamPU Only

# Configure StreamPU paths
set(STREAMPU_INCLUDE_DIRS
    ${STREAMPU_ROOT}/include
    ${STREAMPU_ROOT}/src
    ${STREAMPU_ROOT}/lib/rang/include
    ${STREAMPU_ROOT}/lib/json/include
)
include_directories(${STREAMPU_INCLUDE_DIRS})

# Find StreamPU library
if(EXISTS "${STREAMPU_ROOT}/build/lib/libstreampu.a")
    set(HULOTTE_LIBS "${STREAMPU_ROOT}/build/lib/libstreampu.a")
else()
    message(FATAL_ERROR "libstreampu.a not found at ${STREAMPU_ROOT}/build/lib/libstreampu.a")
endif()
{% endif %}

# Find cpptrace (optional, for better error messages)
find_library(CPPTRACE_LIBRARY NAMES cpptrace libcpptrace.a
    PATHS ${STREAMPU_ROOT}/build/lib/cpptrace/lib)

if(CPPTRACE_LIBRARY)
    list(APPEND HULOTTE_LIBS ${CPPTRACE_LIBRARY})
    include_directories(${STREAMPU_ROOT}/lib/cpptrace/include)
    add_definitions(-DSPU_STACKTRACE)
endif()

{% if use_hw %}
# Hardware Simulation Includes
include_directories(common/hw)
include_directories(common/sw)
{% endif %}

{% if use_streampu %}
add_definitions(-DHULOTTE_USE_STREAMPU)

# ============================================================
# PROJECT SOURCES
# ============================================================
{% else %}
# ============================================================
# PROJECT SOURCES
# ============================================================
{% endif %}

{% if use_hw %}
# Hardware Module (Verilog)
set(VERILOG_SRC 
    common/hw/universal_simulation_top.sv
    common/hw/UART_fifoed_send_V1.sv
    common/hw/uart_recv.sv
    src/hw/Top_Level.sv 
)

# -------------------------------------------------------------
# 1. Generate Verilator Models for each configuration
# -------------------------------------------------------------

# --- Model 1: Direct Mode (USE_UART=0) ---
add_library(VerilatorModel_Direct STATIC common/hw/universal_simulation_top.sv)
verilate(VerilatorModel_Direct
    SOURCES ${VERILOG_SRC}
    TOP_MODULE universal_simulation_top
    PREFIX VModel_Direct
    TRACE
    # Arguments passed to Verilator executable
    VERILATOR_ARGS -Wno-fatal -GUSE_UART=0
)
target_include_directories(VerilatorModel_Direct PUBLIC common/hw)
target_link_libraries(VerilatorModel_Direct PUBLIC Threads::Threads)

# --- Model 2: UART Mode (USE_UART=1) ---
add_library(VerilatorModel_UART STATIC common/hw/universal_simulation_top.sv)
verilate(VerilatorModel_UART
    SOURCES ${VERILOG_SRC}
    TOP_MODULE universal_simulation_top
    PREFIX VModel_UART
    TRACE
    # Arguments passed to Verilator executable
    VERILATOR_ARGS -Wno-fatal -GUSE_UART=1
)
target_include_directories(VerilatorModel_UART PUBLIC common/hw)
target_link_libraries(VerilatorModel_UART PUBLIC Threads::Threads)
{% endif %}

{% if use_custom %}
# Custom module
add_library({{ project_name }}_custom STATIC
    src/custom/MyModule.cpp
)
target_include_directories({{ project_name }}_custom PUBLIC src)
target_link_libraries({{ project_name }}_custom PUBLIC ${HULOTTE_LIBS})

{% if use_streampu or use_aff3ct %}
# Main executable
add_executable({{ project_name }} src/main.cpp)
target_link_libraries({{ project_name }} {{ project_name }}_custom)
{% endif %}

{% else %}
# Main executable
add_executable({{ project_name }} src/main.cpp)
target_link_libraries({{ project_name }} ${HULOTTE_LIBS})
{% endif %}

{% if use_hw %}
# Link Hardware Simulation
target_link_libraries({{ project_name }} VerilatorModel_Direct VerilatorModel_UART Threads::Threads)
{% endif %}
